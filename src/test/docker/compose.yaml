name: integration-test

services:
  postgres:
    image: postgres:17-alpine3.20
    environment:
      POSTGRES_USER: "main-user"
      POSTGRES_PASSWORD: "main-user-password"
    healthcheck:
      test: "pg_isready -U main-user"
      interval: 1s
      start_period: 5s
      retries: 10
  sut:
    image: "arda-cards/postgres-database-initializer"
    build:
      context: "${PWD}/src/main/docker"
    depends_on:
      postgres:
        condition: service_healthy
    command: "postgresql://postgres:5432"
    volumes:
      - "${PWD}/src/test/docker/pgpass:/home/.pgpass"
      - "${PWD}/src/test/docker/values.sql:/home/values.sql"
  idempotency:
    image: "arda-cards/postgres-database-initializer"
    build:
      context: "${PWD}/src/main/docker"
    depends_on:
      postgres:
        condition: service_healthy
    command: "postgresql://postgres:5432"
    volumes:
      - "${PWD}/src/test/docker/pgpass:/home/.pgpass"
      - "${PWD}/src/test/docker/values.sql:/home/values.sql"
  tester:
    image: postgres:17-alpine3.20
    depends_on:
      postgres:
        condition: service_healthy
    command: [
      "psql",
      "-v", "ON_ERROR_STOP=on",
      "-f", "/home/test.sql",
      "postgresql://test_db_owner:test_db_owner_pwd@postgres:5432/test_db"
    ]
    volumes:
      - "${PWD}/src/test/docker/test.sql:/home/test.sql"
